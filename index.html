<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Rico Arcade — Tap Tap</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#05070f;
      --bg1:#070b18;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.10);
      --text:#eef2ff;
      --muted:#a7b0cf;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;

      /* Rico accents */
      --accent:#f9735b;
      --accent2:#0ea5e9;

      --shadow: 0 12px 40px rgba(0,0,0,.55);
      --r: 18px;

      --dailyCap: 500;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Baloo 2", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 700px at 10% 0%, rgba(249,115,91,.18), transparent 60%),
        radial-gradient(900px 700px at 90% 10%, rgba(14,165,233,.16), transparent 60%),
        radial-gradient(700px 600px at 50% 110%, rgba(34,197,94,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{
      max-width: 520px;
      margin: 0 auto;
      padding: 18px 14px 22px;
      padding-bottom: calc(22px + env(safe-area-inset-bottom));
    }

    .top{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-top: 6px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      user-select:none;
    }
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: radial-gradient(circle at 30% 30%, rgba(249,115,91,.95), rgba(14,165,233,.65) 55%, rgba(255,255,255,.12) 100%);
      box-shadow: 0 12px 30px rgba(249,115,91,.18), 0 10px 30px rgba(14,165,233,.14);
      position:relative;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-40%;
      background: conic-gradient(from 210deg, rgba(255,255,255,.0), rgba(255,255,255,.35), rgba(255,255,255,.0));
      animation: spin 2.8s linear infinite;
      opacity:.55;
    }
    @keyframes spin {to{transform:rotate(360deg)}}

    .brand h1{
      font-size: 18px; line-height: 1.05; margin:0;
      letter-spacing:.2px;
    }
    .brand p{
      margin:2px 0 0; color:var(--muted); font-size:13px;
    }

    .pill{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      min-width: 140px;
      justify-content: space-between;
    }
    .pill small{color:var(--muted); font-size:12px}
    .pill b{font-size:16px}

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 14px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: radial-gradient(900px 240px at 20% 0%, rgba(249,115,91,.10), transparent 60%);
    }
    .card .hd .title{
      display:flex; flex-direction:column;
    }
    .card .hd .title b{font-size:15px}
    .card .hd .title span{font-size:12px; color:var(--muted)}
    .chip{
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
      font-size: 12px;
      display:flex; align-items:center; gap:7px;
      white-space:nowrap;
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--good);
      box-shadow: 0 0 14px rgba(34,197,94,.55);
    }

    .content{
      padding: 14px;
    }

    .arena{
      position: relative;
      height: 320px;
      border-radius: 18px;
      background:
        radial-gradient(900px 260px at 50% 115%, rgba(249,115,91,.18), transparent 60%),
        radial-gradient(900px 260px at 40% 110%, rgba(14,165,233,.14), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    .ring{
      width: 260px;
      height: 260px;
      border-radius: 999px;
      position: relative;
      display:grid; place-items:center;
      filter: drop-shadow(0 18px 38px rgba(0,0,0,.55));
    }

    .ring svg{
      position:absolute; inset:0;
      transform: rotate(-90deg);
    }

    .orb{
      width: 180px;
      height: 180px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), rgba(255,255,255,0) 40%),
        radial-gradient(circle at 35% 35%, rgba(249,115,91,.95), rgba(14,165,233,.55) 55%, rgba(0,0,0,.25) 100%);
      border: 1px solid rgba(255,255,255,.20);
      box-shadow:
        0 26px 70px rgba(249,115,91,.14),
        0 26px 70px rgba(14,165,233,.11),
        inset 0 0 0 1px rgba(255,255,255,.08);
      position:relative;
      display:grid; place-items:center;
      transform: translateZ(0);
      transition: transform .08s ease;
    }
    .orb:before{
      content:"";
      position:absolute; inset:-35%;
      background: conic-gradient(from 210deg,
        rgba(249,115,91,0),
        rgba(249,115,91,.18),
        rgba(14,165,233,.18),
        rgba(249,115,91,0));
      filter: blur(16px);
      animation: aura 3.2s linear infinite;
      opacity:.9;
    }
    @keyframes aura{to{transform:rotate(360deg)}}

    .orb .score{
      text-align:center;
      position:relative;
      z-index:2;
      padding: 12px 16px;
      border-radius: 16px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(8px);
    }
    .orb .score .big{
      font-size: 34px;
      font-weight: 800;
      letter-spacing:.3px;
      line-height: 1;
    }
    .orb .score .lbl{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    .tapHint{
      position:absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      color: rgba(255,255,255,.85);
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }

    .stat{
      padding: 12px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.10);
    }
    .stat .k{font-size:12px; color:var(--muted)}
    .stat .v{font-size:16px; font-weight:800; margin-top:4px}

    .actions{
      display:flex; gap:10px; margin-top: 12px;
    }
    .btn{
      flex:1;
      appearance:none;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      font-weight: 800;
      letter-spacing:.2px;
      box-shadow: 0 14px 30px rgba(0,0,0,.28);
      cursor:pointer;
      transition: transform .08s ease, filter .2s ease;
    }
    .btn:active{transform: translateY(1px) scale(.995)}
    .btn.primary{
      border-color: rgba(249,115,91,.35);
      background:
        radial-gradient(1200px 260px at 30% 0%, rgba(249,115,91,.26), transparent 60%),
        linear-gradient(180deg, rgba(249,115,91,.20), rgba(255,255,255,.06));
    }
    .btn.ghost{
      background: rgba(0,0,0,.18);
    }

    .toast{
      position: fixed;
      left:50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      backdrop-filter: blur(12px);
      box-shadow: 0 16px 45px rgba(0,0,0,.45);
      opacity:0;
      pointer-events:none;
      transition: opacity .22s ease, transform .22s ease;
      z-index: 50;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-4px);
    }

    /* floating +points */
    .float{
      position:absolute;
      color: rgba(255,255,255,.95);
      font-weight: 900;
      text-shadow: 0 10px 25px rgba(0,0,0,.55);
      pointer-events:none;
      animation: floatUp .85s ease forwards;
      z-index:10;
    }
    @keyframes floatUp{
      0%{opacity:0; transform: translate(-50%,-50%) scale(.8)}
      10%{opacity:1}
      100%{opacity:0; transform: translate(-50%,-120%) scale(1.05)}
    }

    .footerNote{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
      text-align:center;
    }
    .link{
      color: rgba(255,255,255,.92);
      text-decoration: underline;
      text-decoration-color: rgba(249,115,91,.5);
      text-underline-offset: 3px;
    }

    @media (max-width: 360px){
      .ring{width: 240px; height:240px}
      .orb{width:170px; height:170px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Rico Arcade</h1>
          <p>Tap Tap + Idle Drip • Daily Cap <b>500</b></p>
        </div>
      </div>

      <div class="pill">
        <div>
          <small>Your Points</small><br>
          <b id="points">0</b>
        </div>
        <div style="text-align:right">
          <small>Today</small><br>
          <b id="today">0/500</b>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="hd">
          <div class="title">
            <b>Tap the Orb</b>
            <span>Earn by tapping + idle drip (+1 / 5s)</span>
          </div>
          <div class="chip"><span class="dot" id="statusDot"></span><span id="status">Connecting…</span></div>
        </div>

        <div class="content">
          <div class="arena" id="arena">
            <div class="ring" id="ring">
              <svg viewBox="0 0 100 100" width="260" height="260" aria-hidden="true">
                <defs>
                  <linearGradient id="grad" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0%" stop-color="rgba(249,115,91,0.95)"/>
                    <stop offset="55%" stop-color="rgba(14,165,233,0.85)"/>
                    <stop offset="100%" stop-color="rgba(255,255,255,0.25)"/>
                  </linearGradient>
                </defs>
                <circle cx="50" cy="50" r="45" stroke="rgba(255,255,255,0.10)" stroke-width="6" fill="none"/>
                <circle id="prog" cx="50" cy="50" r="45" stroke="url(#grad)" stroke-width="6" stroke-linecap="round" fill="none"
                        stroke-dasharray="282.743" stroke-dashoffset="282.743"/>
              </svg>

              <div class="orb" id="orb" role="button" aria-label="Tap to earn points">
                <div class="score">
                  <div class="big" id="runPoints">0</div>
                  <div class="lbl">Run points (claim any time)</div>
                </div>
              </div>
            </div>

            <div class="tapHint">Tap fast • +1 every 5s (auto) • Claim when ready</div>
          </div>

          <div class="row">
            <div class="stat">
              <div class="k">Idle drip</div>
              <div class="v" id="drip">+1 / 5s</div>
            </div>
            <div class="stat">
              <div class="k">Tap power</div>
              <div class="v" id="tapPower">+1 / tap</div>
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" id="claimBtn">Claim Run Points</button>
            <button class="btn ghost" id="refreshBtn">Refresh</button>
          </div>

          <div class="footerNote">
            Tip: Keep it fair — daily max <b>500</b>. Anti-cheat checks are server-side.
            <br/>If you’re testing in browser (not Telegram), it runs in “demo mode”.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  // ========= Config =========
  const API_BASE = ""; // same domain (Cloudflare Pages -> bind to Worker via route or proxy). For now keep empty.
  const DAILY_CAP = 500;

  // ========= Telegram WebApp =========
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.ready();
    tg.expand();
    try { tg.setHeaderColor?.("#05070f"); tg.setBackgroundColor?.("#05070f"); } catch(e){}
  }

  // ========= UI refs =========
  const $points = document.getElementById("points");
  const $today = document.getElementById("today");
  const $runPoints = document.getElementById("runPoints");
  const $prog = document.getElementById("prog");
  const $status = document.getElementById("status");
  const $statusDot = document.getElementById("statusDot");
  const $orb = document.getElementById("orb");
  const $arena = document.getElementById("arena");
  const $toast = document.getElementById("toast");
  const $claimBtn = document.getElementById("claimBtn");
  const $refreshBtn = document.getElementById("refreshBtn");

  // ========= State =========
  let me = {
    telegram_id: null,
    username: null,
    points: 0,
    earned_today: 0,
    pending_run: 0
  };

  // local demo timers
  let demoDripTimer = null;
  let demoConnected = false;

  // ========= Helpers =========
  const fmt = (n) => String(Math.max(0, Math.floor(n || 0)));
  function toast(msg){
    $toast.textContent = msg;
    $toast.classList.add("show");
    setTimeout(()=> $toast.classList.remove("show"), 1200);
  }
  function setStatus(ok, text){
    $status.textContent = text;
    $statusDot.style.background = ok ? "var(--good)" : "var(--warn)";
    $statusDot.style.boxShadow = ok ? "0 0 14px rgba(34,197,94,.55)" : "0 0 14px rgba(245,158,11,.55)";
  }
  function setProgress(){
    const circumference = 2 * Math.PI * 45; // ~282.743
    const ratio = Math.min(1, (me.earned_today / DAILY_CAP));
    const offset = circumference * (1 - ratio);
    $prog.style.strokeDashoffset = String(offset);
  }
  function render(){
    $points.textContent = fmt(me.points);
    $today.textContent = `${fmt(me.earned_today)}/${DAILY_CAP}`;
    $runPoints.textContent = fmt(me.pending_run);
    setProgress();
    $claimBtn.disabled = me.pending_run <= 0 || me.earned_today >= DAILY_CAP;
  }

  function floatAt(x,y,text){
    const el = document.createElement("div");
    el.className = "float";
    el.textContent = text;
    el.style.left = x + "px";
    el.style.top = y + "px";
    $arena.appendChild(el);
    setTimeout(()=> el.remove(), 900);
  }

  function haptic(type="light"){
    try { tg?.HapticFeedback?.impactOccurred(type); } catch(e){}
  }

  // ========= Game mechanics (client) =========
  function canEarnMore(){
    return me.earned_today < DAILY_CAP;
  }

  function addRunPoints(amount, x, y, label="+1"){
    if (!canEarnMore()) {
      toast("Daily cap reached.");
      return;
    }
    // NOTE: In real mode, server will cap. This is just “pending run” client feel.
    me.pending_run += amount;
    render();
    if (typeof x === "number" && typeof y === "number") floatAt(x,y,label);
  }

  // Tap handler
  $orb.addEventListener("pointerdown", (ev) => {
    ev.preventDefault();
    $orb.style.transform = "scale(0.985)";
    setTimeout(()=> $orb.style.transform = "scale(1)", 80);

    const rect = $arena.getBoundingClientRect();
    const x = ev.clientX - rect.left;
    const y = ev.clientY - rect.top;

    if (tg) haptic("light");
    addRunPoints(1, x, y, "+1");
  }, {passive:false});

  // ========= Networking =========
  async function api(path, body){
    const initData = tg?.initData || ""; // signed payload in Telegram
    const res = await fetch(API_BASE + path, {
      method: body ? "POST" : "GET",
      headers: {
        "content-type": "application/json",
        "x-telegram-initdata": initData
      },
      body: body ? JSON.stringify(body) : undefined
    });
    if (!res.ok) throw new Error(await res.text());
    return await res.json();
  }

  async function loadMe(){
    // If not inside Telegram, run demo mode
    if (!tg) {
      demoConnected = true;
      setStatus(true, "Demo mode");
      // fake user
      me.telegram_id = "demo";
      me.username = "demo";
      me.points = me.points || 0;
      me.earned_today = me.earned_today || 0;
      render();
      startDemoDrip();
      return;
    }

    try{
      const data = await api("/api/me");
      me.telegram_id = data.telegram_id;
      me.username = data.username;
      me.points = data.points;
      me.earned_today = data.earned_today;
      me.pending_run = 0;
      setStatus(true, "Connected");
      render();
      // ask server to apply drip (every refresh / open)
      await applyDrip();
      // schedule drip tick (server validated)
      startServerDripLoop();
    }catch(e){
      console.error(e);
      setStatus(false, "Offline (tap still works)");
      toast("Backend not reachable. You can still test UI.");
      // Allow taps to feel good even offline, but won’t persist.
      startDemoDrip();
    }
  }

  async function applyDrip(){
    // Server adds +1 per 5s elapsed since last_drip_at, respecting daily cap.
    try{
      const data = await api("/api/drip", { });
      me.points = data.points;
      me.earned_today = data.earned_today;
      render();
    }catch(e){
      console.warn("drip failed", e);
    }
  }

  let serverDripTimer = null;
  function startServerDripLoop(){
    if (serverDripTimer) clearInterval(serverDripTimer);
    // check every ~7s so we don’t spam; server calculates elapsed anyway
    serverDripTimer = setInterval(applyDrip, 7000);
  }

  function startDemoDrip(){
    if (demoDripTimer) return;
    demoDripTimer = setInterval(()=>{
      if (!canEarnMore()) return;
      // demo drip adds directly to points (no server)
      me.points += 1;
      me.earned_today += 1;
      render();
    }, 5000);
  }

  async function claimRun(){
    if (me.pending_run <= 0) return;
    if (!tg) {
      // demo claim
      const grant = Math.min(me.pending_run, DAILY_CAP - me.earned_today);
      me.points += grant;
      me.earned_today += grant;
      me.pending_run = 0;
      render();
      toast(`Claimed +${grant}`);
      return;
    }

    try{
      const data = await api("/api/tap/claim", { amount: me.pending_run });
      me.points = data.points;
      me.earned_today = data.earned_today;
      me.pending_run = 0;
      render();
      toast(`Claimed +${data.claimed}`);
      haptic("medium");
    }catch(e){
      console.error(e);
      toast("Claim failed");
    }
  }

  $claimBtn.addEventListener("click", claimRun);
  $refreshBtn.addEventListener("click", loadMe);

  // boot
  loadMe();
</script>
</body>
</html>
